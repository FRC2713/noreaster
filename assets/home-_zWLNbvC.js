import{r as w,j as e,L as o}from"./index-BzDMXz7D.js";import{u}from"./useQuery-oqX81evD.js";import{s as m}from"./client-SuhK6xMp.js";import{M as N}from"./match-card-BjjfZycy.js";import{B as p}from"./button-Bvz0UuGA.js";import"./index-DRZSS2nR.js";async function S(){const{data:c,error:l}=await m.from("alliances").select("id, name");if(l)throw l;return c??[]}async function R(){const{data:c,error:l}=await m.from("matches").select("id, red_alliance_id, blue_alliance_id, scheduled_at, red_score, blue_score, red:alliances!matches_red_alliance_id_fkey(name), blue:alliances!matches_blue_alliance_id_fkey(name)").is("red_score",null).is("blue_score",null).order("scheduled_at",{ascending:!0,nullsFirst:!0}).limit(10);if(l)throw l;return c??[]}async function k(){const{data:c,error:l}=await m.from("matches").select("id, red_alliance_id, blue_alliance_id, scheduled_at, red_score, blue_score, red_coral_rp, red_auto_rp, red_barge_rp, blue_coral_rp, blue_auto_rp, blue_barge_rp");if(l)throw l;return c??[]}async function L(){const{data:c,error:l}=await m.from("matches").select("id, red_alliance_id, blue_alliance_id, scheduled_at, red_score, blue_score, red:alliances!matches_red_alliance_id_fkey(name), blue:alliances!matches_blue_alliance_id_fkey(name)").not("red_score","is",null).not("blue_score","is",null).order("scheduled_at",{ascending:!1}).limit(5);if(l)throw l;return c??[]}function H(){const{data:c=[]}=u({queryKey:["alliances","list"],queryFn:S}),{data:l=[],isLoading:b,error:h}=u({queryKey:["matches","upcoming"],queryFn:R}),{data:f=[],isLoading:g,error:_}=u({queryKey:["matches","for-ranking"],queryFn:k}),{data:j=[],isLoading:y,error:x}=u({queryKey:["matches","previous"],queryFn:L});function i(a){return c.find(t=>t.id===a)?.name??a}const v=w.useMemo(()=>{const a=new Map;c.forEach(r=>a.set(r.id,{id:r.id,name:r.name,played:0,totalRp:0,totalScore:0,counted:0}));const t=(r,s)=>{const d=a.get(r);d&&(d.totalRp+=s)};for(const r of f){const s=a.get(r.red_alliance_id),d=a.get(r.blue_alliance_id);!s||!d||!(r.red_score!=null&&r.blue_score!=null)||(s.played+=1,d.played+=1,r.red_score>r.blue_score?t(s.id,3):r.blue_score>r.red_score?t(d.id,3):(t(s.id,1),t(d.id,1)),t(s.id,(r.red_coral_rp?1:0)+(r.red_auto_rp?1:0)+(r.red_barge_rp?1:0)),t(d.id,(r.blue_coral_rp?1:0)+(r.blue_auto_rp?1:0)+(r.blue_barge_rp?1:0)),s.totalScore+=r.red_score,s.counted+=1,d.totalScore+=r.blue_score,d.counted+=1)}const n=Array.from(a.values()).map(r=>({...r,avgRp:r.played>0?r.totalRp/r.played:0,avgScore:r.counted>0?r.totalScore/r.counted:0}));return n.sort((r,s)=>s.avgRp-r.avgRp||s.avgScore-r.avgScore||r.name.localeCompare(s.name)),n.map((r,s)=>({rank:s+1,...r})).slice(0,8)},[c,f]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Dashboard"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{to:"/matches",children:e.jsx(p,{variant:"outline",children:"Matches"})}),e.jsx(o,{to:"/rankings",children:e.jsx(p,{variant:"outline",children:"Rankings"})}),e.jsx(o,{to:"/schedule",children:e.jsx(p,{variant:"outline",children:"Schedule"})})]})]}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsxs("section",{className:"rounded-lg border",children:[e.jsxs("div",{className:"border-b px-4 py-3 flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Upcoming Matches"}),e.jsx(o,{to:"/matches/preview",className:"text-sm underline",children:"Preview"})]}),e.jsxs("div",{className:"p-4",children:[b&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading…"}),h&&e.jsx("div",{className:"text-sm text-red-600",children:String(h)}),!b&&!h&&(l.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"No upcoming matches."}):e.jsx("ul",{className:"grid gap-2",children:l.map(a=>{const t=Array.isArray(a.red)?a.red[0]?.name??i(a.red_alliance_id):a.red?.name??i(a.red_alliance_id),n=Array.isArray(a.blue)?a.blue[0]?.name??i(a.blue_alliance_id):a.blue?.name??i(a.blue_alliance_id);return e.jsx("li",{children:e.jsx(N,{scheduledAt:a.scheduled_at,redName:t,blueName:n,redScore:a.red_score,blueScore:a.blue_score,showRelativeTime:!0,editHref:`/matches/${a.id}`})},a.id)})}))]})]}),e.jsxs("section",{className:"rounded-lg border overflow-hidden",children:[e.jsxs("div",{className:"border-b px-4 py-3 flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Rankings (Top 8)"}),e.jsx(o,{to:"/rankings",className:"text-sm underline",children:"View all"})]}),e.jsxs("div",{className:"p-4 overflow-x-auto",children:[g&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading…"}),_&&e.jsx("div",{className:"text-sm text-red-600",children:String(_)}),!g&&!_&&e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"text-left opacity-70",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-1 pr-3",children:"Rank"}),e.jsx("th",{className:"py-1 pr-3",children:"Alliance"}),e.jsx("th",{className:"py-1 pr-3",children:"Played"}),e.jsx("th",{className:"py-1 pr-3",children:"Avg RP"}),e.jsx("th",{className:"py-1",children:"Avg Score"})]})}),e.jsx("tbody",{children:v.map(a=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"py-1 pr-3 font-medium",children:a.rank}),e.jsx("td",{className:"py-1 pr-3",children:a.name}),e.jsx("td",{className:"py-1 pr-3",children:a.played}),e.jsx("td",{className:"py-1 pr-3",children:a.avgRp.toFixed(3)}),e.jsx("td",{className:"py-1",children:a.avgScore.toFixed(1)})]},a.id))})]})]})]})]}),e.jsxs("section",{className:"rounded-lg border",children:[e.jsxs("div",{className:"border-b px-4 py-3 flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Recent Matches"}),e.jsx(o,{to:"/matches",className:"text-sm underline",children:"View all"})]}),e.jsxs("div",{className:"p-4",children:[y&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading…"}),x&&e.jsx("div",{className:"text-sm text-red-600",children:String(x)}),!y&&!x&&(j.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"No completed matches."}):e.jsx("ul",{className:"grid gap-2",children:j.map(a=>{const t=Array.isArray(a.red)?a.red[0]?.name??i(a.red_alliance_id):a.red?.name??i(a.red_alliance_id),n=Array.isArray(a.blue)?a.blue[0]?.name??i(a.blue_alliance_id):a.blue?.name??i(a.blue_alliance_id);return e.jsx("li",{children:e.jsx(N,{scheduledAt:a.scheduled_at,redName:t,blueName:n,redScore:a.red_score,blueScore:a.blue_score,editHref:`/matches/${a.id}`})},a.id)})}))]})]})]})}export{H as default};
