import{j as e}from"./ui-vendor-L3tEH77r.js";import{k as B,u as O,r as l,L as Y}from"./react-vendor-BE_oCUfB.js";import{u as z,B as h,s as n}from"./index-Ecy2JF11.js";import{A as G,R as H}from"./robot-image-Bcp4jQFy.js";import{L as F,I}from"./label-BCkcLO7k.js";import{u as J,c as p,b as V}from"./query-vendor-DjGQMdFW.js";import"./supabase-vendor-BfNnX3KH.js";import"./utils-vendor-BC32Okw2.js";import"./icons-vendor-NdmwdHec.js";function le(){const{allianceId:t}=B(),d=O(),{user:c,loading:u}=z(),[x,j]=l.useState(""),[R,C]=l.useState([null,null,null,null]),[i,v]=l.useState(null),[b,g]=l.useState(null),[y,w]=l.useState(!1),N=J();l.useEffect(()=>{!u&&!c&&d("/auth")},[c,u,d]);const{data:o,isLoading:U,error:M}=p({queryKey:["alliances","byId",t],queryFn:async()=>{if(!t)return null;const{data:a,error:s}=await n.from("alliances").select("id, name, emblem_image_url, created_at").eq("id",t).single();if(s)throw s;return a}}),{data:f=[],isLoading:k,error:K}=p({queryKey:["alliance_teams","byAlliance",t],queryFn:async()=>{if(!t)return[];const{data:a,error:s}=await n.from("alliance_teams").select("team_id, slot").eq("alliance_id",t).order("slot",{ascending:!0});if(s)throw s;return a??[]}}),m=(f??[]).map(a=>a.team_id),{data:_=[],isLoading:T,error:D}=p({queryKey:["teams","byIds",m.sort().join(",")],queryFn:async()=>{if(!m.length)return[];const{data:a,error:s}=await n.from("teams").select("id, number, name, robot_image_url").in("id",m);if(s)throw s;return a??[]},enabled:m.length>0});l.useEffect(()=>{o&&j(o.name??"");const a=new Map((_??[]).map(r=>[r.id,r])),s=[null,null,null,null];(f??[]).forEach(r=>{r.slot>=1&&r.slot<=4&&(s[r.slot-1]=a.get(r.team_id)??null)}),C(s)},[o,f,_]);const S=l.useMemo(()=>i?URL.createObjectURL(i):o?.emblem_image_url??null,[i,o]),P=V({mutationFn:async()=>{if(!t)return;if(!c)throw new Error("You must be signed in to save changes");g(null);const{data:{user:a},error:s}=await n.auth.getUser();if(s||!a)throw new Error("Authentication failed. Please sign in again.");let r=o?.emblem_image_url??null;if(i){const Q=(i.name.split(".").pop()||"png").toLowerCase(),q=`images/${Date.now()}_${Math.random().toString(16).slice(2,8)}.${Q}`,{error:A}=await n.storage.from("alliances").upload(q,i,{cacheControl:"3600",upsert:!1,contentType:i.type});if(A)throw A;const{data:$}=n.storage.from("alliances").getPublicUrl(q);r=$.publicUrl}const{error:L}=await n.from("alliances").update({name:x,emblem_image_url:r}).eq("id",t);if(L)throw L},onSuccess:()=>{g("Saved."),v(null),N.invalidateQueries({queryKey:["alliances","byId",t]}),N.invalidateQueries({queryKey:["alliances","polling"]})},onError:a=>{const s=a instanceof Error?a.message:"Failed to save";g(s)},onSettled:()=>w(!1)});if(!t)return e.jsx("p",{children:"Missing alliance id"});if(u)return e.jsx("p",{children:"Checking authentication..."});if(!c)return e.jsx("p",{children:"Redirecting to sign in..."});if(U||k||T)return e.jsx("p",{children:"Loading alliance..."});const E=M||K||D;return E?e.jsxs("p",{className:"text-red-600",children:["Error: ",String(E)]}):e.jsxs("div",{className:"space-y-6 max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{to:"/alliances",children:e.jsx(h,{variant:"ghost",children:"← Back"})}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Alliance"}),e.jsx("div",{className:"ml-auto flex items-center gap-3",children:e.jsx(h,{variant:"destructive",onClick:()=>{confirm(`Are you sure you want to delete "${o?.name}"? This will remove the alliance and unassign its teams. This action cannot be undone.`)&&(n.from("alliance_teams").delete().eq("alliance_id",t),n.from("alliances").delete().eq("id",t),d("/alliances"))},children:"Delete Alliance"})})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-[220px_1fr]",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{ratio:1,className:"rounded-md border overflow-hidden bg-muted",children:S?e.jsx("img",{src:S,alt:"Alliance emblem",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full grid place-items-center text-sm text-muted-foreground",children:"No emblem"})}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(F,{htmlFor:"emblem",children:"Emblem (1:1)"}),e.jsx(I,{id:"emblem",type:"file",accept:"image/*",onChange:a=>v(a.target.files?.[0]??null)})]})]}),e.jsxs("form",{onSubmit:a=>{a.preventDefault(),w(!0),P.mutate()},className:"grid gap-3 content-start",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(F,{htmlFor:"name",children:"Alliance Name"}),e.jsx(I,{id:"name",value:x,onChange:a=>j(a.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(h,{type:"submit",disabled:y,children:y?"Saving...":"Save"}),b&&e.jsx("span",{className:"text-sm opacity-80",children:b})]})]})]}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:R.map((a,s)=>e.jsxs("div",{className:"border rounded-md overflow-hidden",children:[e.jsx(H,{team:a??{id:"_",number:0,name:"No Team",robot_image_url:null},className:"w-full bg-muted"}),e.jsxs("div",{className:"p-3 text-sm",children:[e.jsxs("div",{className:"opacity-70 mb-1",children:["Slot ",s+1]}),a?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:a.number}),e.jsx("div",{className:"opacity-80",children:a.name})]}):e.jsx("div",{className:"text-muted-foreground",children:"Unassigned"})]})]},s))})]})}export{le as default};
