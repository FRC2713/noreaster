import{b as B,r as n,a as D,j as e,L as P,s as o}from"./index-BbsRpNjG.js";import{A as T,R as $}from"./robot-image-lizaRGwK.js";import{B as S}from"./button-DzpIyQ-0.js";import{L,I as E}from"./label-CisLujVD.js";import{u}from"./useQuery-CDvurSQj.js";import{u as k}from"./useMutation-Ce0TQO7E.js";function W(){const{allianceId:r}=B(),[g,f]=n.useState(""),[q,F]=n.useState([null,null,null,null]),[l,p]=n.useState(null),[x,m]=n.useState(null),[h,b]=n.useState(!1),j=D(),{data:i,isLoading:I,error:R}=u({queryKey:["alliances","byId",r],queryFn:async()=>{if(!r)return null;const{data:a,error:s}=await o.from("alliances").select("id, name, emblem_image_url, created_at").eq("id",r).single();if(s)throw s;return a}}),{data:d=[],isLoading:A,error:C}=u({queryKey:["alliance_teams","byAlliance",r],queryFn:async()=>{if(!r)return[];const{data:a,error:s}=await o.from("alliance_teams").select("team_id, slot").eq("alliance_id",r).order("slot",{ascending:!0});if(s)throw s;return a??[]}}),c=(d??[]).map(a=>a.team_id),{data:v=[],isLoading:M,error:U}=u({queryKey:["teams","byIds",c.sort().join(",")],queryFn:async()=>{if(!c.length)return[];const{data:a,error:s}=await o.from("teams").select("id, number, name, robot_image_url").in("id",c);if(s)throw s;return a??[]},enabled:c.length>0});n.useEffect(()=>{i&&f(i.name??"");const a=new Map((v??[]).map(t=>[t.id,t])),s=[null,null,null,null];(d??[]).forEach(t=>{t.slot>=1&&t.slot<=4&&(s[t.slot-1]=a.get(t.team_id)??null)}),F(s)},[i,d,v]);const y=n.useMemo(()=>l?URL.createObjectURL(l):i?.emblem_image_url??null,[l,i]),K=k({mutationFn:async()=>{if(!r)return;m(null);let a=i?.emblem_image_url??null;if(l){const t=(l.name.split(".").pop()||"png").toLowerCase(),w=`emblems/${Date.now()}_${Math.random().toString(16).slice(2,8)}.${t}`,{error:_}=await o.storage.from("alliances").upload(w,l,{cacheControl:"3600",upsert:!1,contentType:l.type});if(_)throw _;const{data:Q}=o.storage.from("alliances").getPublicUrl(w);a=Q.publicUrl}const{error:s}=await o.from("alliances").update({name:g,emblem_image_url:a}).eq("id",r);if(s)throw s},onSuccess:()=>{m("Saved."),p(null),j.invalidateQueries({queryKey:["alliances","byId",r]}),j.invalidateQueries({queryKey:["alliances","list"]})},onError:a=>{const s=a instanceof Error?a.message:"Failed to save";m(s)},onSettled:()=>b(!1)});if(!r)return e.jsx("p",{children:"Missing alliance id"});if(I||A||M)return e.jsx("p",{children:"Loading alliance..."});const N=R||C||U;return N?e.jsxs("p",{className:"text-red-600",children:["Error: ",String(N)]}):e.jsxs("div",{className:"space-y-6 max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(P,{to:"/alliances",children:e.jsx(S,{variant:"ghost",children:"← Back"})}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Alliance"})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-[220px_1fr]",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{ratio:1,className:"rounded-md border overflow-hidden bg-muted",children:y?e.jsx("img",{src:y,alt:"Alliance emblem",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full grid place-items-center text-sm text-muted-foreground",children:"No emblem"})}),e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(L,{htmlFor:"emblem",children:"Emblem (1:1)"}),e.jsx(E,{id:"emblem",type:"file",accept:"image/*",onChange:a=>p(a.target.files?.[0]??null)})]})]}),e.jsxs("form",{onSubmit:a=>{a.preventDefault(),b(!0),K.mutate()},className:"grid gap-3 content-start",children:[e.jsxs("div",{className:"grid gap-1.5",children:[e.jsx(L,{htmlFor:"name",children:"Alliance Name"}),e.jsx(E,{id:"name",value:g,onChange:a=>f(a.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S,{type:"submit",disabled:h,children:h?"Saving...":"Save"}),x&&e.jsx("span",{className:"text-sm opacity-80",children:x})]})]})]}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:q.map((a,s)=>e.jsxs("div",{className:"border rounded-md overflow-hidden",children:[e.jsx($,{team:a??{id:"_",number:0,name:"No Team",robot_image_url:null},className:"w-full bg-muted"}),e.jsxs("div",{className:"p-3 text-sm",children:[e.jsxs("div",{className:"opacity-70 mb-1",children:["Slot ",s+1]}),a?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:a.number}),e.jsx("div",{className:"opacity-80",children:a.name})]}):e.jsx("div",{className:"text-muted-foreground",children:"Unassigned"})]})]},s))})]})}export{W as default};
