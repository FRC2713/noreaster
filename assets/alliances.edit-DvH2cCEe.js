import{j as e}from"./ui-vendor-CWhAcX5I.js";import{D,r as I,u as L,a as T}from"./dnd-vendor-Ce81eydQ.js";import{B as q,s as m}from"./index-DDBma67i.js";import{L as R}from"./react-vendor-BE_oCUfB.js";import{C as j,a as b,b as S,c as k}from"./card-DCxV3Rmh.js";import{u as E,c as M,b as v}from"./query-vendor-Cs1Z885O.js";import{u as w}from"./use-alliances-polling-1S8ZN4KI.js";import{R as Q}from"./robot-image-BalY4Rkk.js";import"./supabase-vendor-BfNnX3KH.js";import"./utils-vendor-Dkv1a4Vh.js";import"./icons-vendor-NdmwdHec.js";function U(){const{lastUpdated:t,isLoading:n,error:i}=w();return i?e.jsxs("div",{className:"text-xs text-red-600 bg-red-50 px-2 py-1 rounded",children:["Error: ",i]}):n?e.jsx("div",{className:"text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded",children:"Updating..."}):t?e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Last updated: ",t.toLocaleTimeString()]}):null}function N({id:t,className:n,children:i}){const{setNodeRef:c,isOver:l}=L({id:t});return e.jsx("div",{ref:c,className:`${n??""} ${l?"ring-2 ring-primary":""}`.trim(),children:i})}function y({team:t}){const{attributes:n,listeners:i,setNodeRef:c,transform:l,isDragging:u}=T({id:`team:${t.id}`}),x=l?{transform:`translate3d(${l.x}px, ${l.y}px, 0)`}:{};return e.jsx("div",{ref:c,style:x,...i,...n,className:`cursor-grab active:cursor-grabbing select-none border rounded-md p-4 bg-background hover:bg-accent w-full h-full min-h-[80px] max-w-[300px] ${u?"opacity-70":""}`,title:`${t.number} ${t.name}`,children:e.jsxs("div",{className:"flex items-center gap-3 h-full",children:[e.jsx("div",{className:"w-12 h-12 rounded overflow-hidden bg-muted flex-shrink-0",children:e.jsx(Q,{team:t,className:"w-full h-full"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"font-semibold leading-tight text-lg",children:t.number}),e.jsx("div",{className:"text-sm text-muted-foreground truncate",children:t.name})]})]})})}function X(){const{alliances:t,teams:n,isLoading:i,error:c}=w(),l=E(),{data:u}=M({queryKey:["auth","user"],queryFn:async()=>{const{data:{user:s}}=await m.auth.getUser();return{user:s}}}),x=u?.user,h=n.filter(s=>!new Set(t.flatMap(a=>a.teams.filter(Boolean).map(d=>d.id))).has(s.id)),$=v({mutationFn:async s=>{const{data:r,error:a}=await m.from("alliances").insert({name:s}).select("id, name, created_at").single();if(a)throw a;return r},onSuccess:()=>{l.invalidateQueries({queryKey:["alliances","polling"]})}}),C=v({mutationFn:async s=>{const{teamId:r,allianceId:a,slot:d}=s;if(await m.from("alliance_teams").delete().eq("team_id",r),a&&d){const{error:o}=await m.from("alliance_teams").insert({alliance_id:a,team_id:r,slot:d});if(o)throw o}},onSuccess:()=>{l.invalidateQueries({queryKey:["alliance_teams","polling"]})}});function A(){const s=`Alliance ${t.length+1}`;$.mutate(s)}function g(s,r,a){C.mutate({teamId:s,allianceId:r,slot:a})}function _(s){const r=s.active?.id??"",a=s.over?.id??"";if(!r||!r.startsWith("team:"))return;const d=r.slice(5);if(a){if(a==="available"){g(d,null,null);return}if(a.startsWith("alliance:")){const o=a.split(":"),p=o[1],f=Number(o[3]??"0");if(!p||!(f>=1&&f<=4))return;g(d,p,f);return}}}return i?e.jsx("p",{children:"Loading alliances..."}):c?e.jsxs("p",{className:"text-red-600",children:["Error: ",c]}):e.jsx(D,{onDragEnd:_,collisionDetection:I,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Teams"}),e.jsx(U,{})]}),e.jsx(j,{children:e.jsx(b,{className:"p-3",children:e.jsx(N,{id:"available",className:"min-h-[200px] rounded-md border p-3",children:e.jsxs("div",{className:"grid gap-3",children:[h.map(s=>e.jsx(y,{team:s},s.id)),h.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground",children:"All teams are assigned."})]})})})})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Alliances"}),x&&e.jsx(q,{onClick:A,children:"New Alliance"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[t.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground col-span-full",children:"No alliances yet. Create one to begin."}),t.map(s=>e.jsxs(j,{children:[e.jsx(S,{className:"pb-3",children:e.jsx("div",{className:"flex items-center justify-between gap-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-muted flex-shrink-0",children:s.emblem_image_url?e.jsx("img",{src:s.emblem_image_url,alt:`${s.name} emblem`,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full grid place-items-center text-xs text-muted-foreground",children:s.name.charAt(0).toUpperCase()})}),e.jsx(k,{className:"text-base",children:e.jsx(R,{to:`/alliances/${s.id}`,className:"hover:underline",children:s.name})})]})})}),e.jsx(b,{className:"pt-0",children:e.jsx("div",{className:"grid grid-cols-2 gap-3",children:s.teams.map((r,a)=>e.jsx(N,{id:`alliance:${s.id}:slot:${a+1}`,className:"min-h-24 rounded-md border bg-muted/30 grid place-items-center",children:e.jsx("div",{className:"h-full w-full grid place-items-center",children:r?e.jsx(y,{team:r}):e.jsxs("div",{className:"h-full w-full grid place-items-center text-xs text-muted-foreground",children:["Slot ",a+1]})})},`${s.id}:${a+1}`))})})]},s.id))]})]})]})})}export{X as default};
